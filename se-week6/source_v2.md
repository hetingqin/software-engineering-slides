# 软件工程及体系结构 · 第 6 周

## 架构设计与技术选型：搭好系统的承重墙

> 电子信息工程专业硕士 | 3 学时
> 主讲人 | 何庭钦 | 271880026@qq.com

---

## 第一讲：架构设计——为什么需要架构？

### 1. 从个人英雄主义到团队协作

在软件工程的早期阶段，确实存在过个人英雄主义的时代：张小龙一个人完成了 Foxmail，求伯君独立开发了初代 WPS，王江民编写了 KV 杀毒软件。但那时候的软件规模远不能和今天相比。如今的软件系统——无论是淘宝、微信还是任何一个大型互联网产品——动辄百万行代码，涉及几十甚至上百名开发者同时协作。没有任何个人能独立完成这样的工程。

架构设计要解决的核心问题就是：**让一群能力各异的普通工程师，能够协同构建出一个复杂的大型系统，而不必依赖少数精英。**

### 2. 技术复杂性的四个来源

复杂的软件项目面临四方面的技术复杂性：

**需求驱动的复杂性**：一个个人博客网站和一个淘宝级别的电商平台，技术复杂度有天壤之别。而且需求持续变化，新的需求可能会破坏原有的代码结构，导致系统越来越臃肿难以维护。

**人员导致的复杂性**：团队成员水平参差不齐，技术偏好各异，如何让这群人有效协作本身就是巨大的挑战。几十人修改同一组文件，版本冲突将成为日常噩梦。

**技术自身的复杂性**：现代软件项目涉及编程语言、框架、中间件、数据库、微服务、容器化等众多技术选项，每一项都需要学习成本。

**运行时的不确定性**：软件在生产环境中面临各种不可预测的情况——明星发微博可能导致服务器崩溃，云服务故障可能让依赖它的所有系统同时瘫痪。

### 3. 架构设计如何解决这些问题？

**降低需求响应成本**：通过分拆系统，把复杂的大系统拆成若干简单的子系统。淘宝最终被拆分为成百上千个微服务后，单个微服务的开发难度和一个小型网站差不多，普通工程师完全可以胜任。通过分层架构把界面和业务逻辑隔离，界面改版不影响业务代码，更换数据库引擎也不需要修改界面。

**组织团队高效协作**：通过系统分拆，开发团队也随之分拆成若干小组，每个小组独立负责一个子系统或模块。小组之间通过明确定义的接口和协议协作，互不干扰。

**组织管理各种技术**：架构设计用合适的编程语言和协议，将框架、组件、数据库等有效地组织在一起。例如分层架构中，前端用 React/Vue 处理界面逻辑，后端用 Web 框架提供服务，数据访问层通过数据库接口读写数据。

**保障稳定运行**：分布式架构将流量分散到不同服务器，单台压力不大；异地多活方案确保一个机房故障后其他机房能无缝接管。

### 4. 架构设计的本质

**架构设计的"道"，就是将系统和团队拆分，安排好切分后各部分的排列关系，让拆分后的部分能通过约定好的协议（如 REST API、方法调用、消息队列）相互通信，共同实现最终的结果。** 这就像乐高玩具——把小的模块通过标准接口拼接在一起，搭成一个大的模型。

架构设计的目标不仅是让系统能工作（这是最低要求），而是**用最小的人力成本来满足需求的开发和响应需求的变化，用最小的运行成本来保障软件的运行。**

---

## 第二讲：架构设计的四个步骤

### Step 1：分析需求，提取用例

在考虑用什么技术之前，首先要搞清楚需求。一个常用的方法是分析用例——了解主要的用户角色以及他们在系统中的操作场景。

以某专栏APP为例，通过用例分析可以识别出四种角色：编辑、专栏作者、未付费用户和付费用户。每种角色有其独特的功能需求，有些功能在角色之间是共享的。将这些信息绘制成用例图，可以清晰地看到系统需要实现的功能全貌。

![用例图](../../assets/af6b79d303f126d9e2f547b1a604ef22.png)

### Step 2：选择成熟的架构模式

不需要从零发明架构。业界已经沉淀了大量经过验证的架构模式（分层架构、微服务架构、事件驱动架构等），可以在理解需求之后，找到最贴合的成熟方案进行改造。

以某专栏APP为例，第一个版本只有专栏课程一个核心功能，目标日 PV 上万——这是一个典型的网站架构。基于传统的**分层架构**即可满足要求。分层架构将系统划分为表现层、服务层、业务逻辑层和数据访问层，每层职责明确，只与相邻层交互。

![分层架构](../../assets/eb230b721a36aaed80afbfd7641abf88.png)

选择架构方案的同时还需要确定语言和框架。选择的原则不是"哪个最先进"，而是"哪个最适合当前团队"——团队以 PHP 程序员为主就不要贸然选 Java，这样可以最大限度降低学习成本。

### Step 3：自顶向下层层细化

从整体架构出发，逐步深入到部署架构、分层分模块设计、API 设计和数据库设计等具体层面。

**部署架构的演进**：基于云服务设计部署方案。初始版本只需一台云服务器加云数据库即可运行。但要满足高可用性要求，需要增加异地备份服务器和数据库实例——当主节点故障时，备用节点能立即接管，确保服务不中断。

![多活部署](../../assets/35f3abd053654cd23896c7259d5258c0.png)

**分层分模块**：先按分层架构拆成四层，再在每一层中把相关功能聚合成模块（留言模块、文稿模块、用户模块等）。分层分模块完成后，可以将具体工作细分到"某一层的某个模块"，每个开发者的职责非常明确。

### Step 4：验证和优化

架构方案不是确定后就不变了。需要通过评审会议、性能测试来验证方案是否满足目标。在实际运行中如果发现问题（例如 API 流量过大拖慢网站），就需要对架构进行调整和优化（如将 API 服务和网站服务拆分为独立部署）。

架构设计要考虑预期满足多长时间的业务增长——半年、一年还是三年。既不能过度设计导致不必要的成本，也不能设计得太紧凑导致很快就需要推翻重来。

---

## 第三讲：技术选型——如何做出正确的技术决策

### 1. 技术选型是项目决策，不是信仰竞赛

技术社区中关于技术选型的争论从未停歇。但技术选型的本质不是技术信仰的竞赛，而是一种受约束的项目决策，必须在架构设计目标的指导下做出选择。

### 2. 警惕"不需要的选型"

在急于引入新技术之前，先问一个根本问题：真的需要技术选型吗？很多时候问题可以通过优化现有方案解决。经典案例：团队发现数据库查询慢，提出花三个月迁移到 NoSQL——结果只是忘了加索引，加上之后速度提升 20 倍。

![技术选型漫画](../../assets/fe1f72418d928840b0412e25e734b3f3.png)

### 3. 技术选型的三大约束

**时间约束**：项目的交付期限直接决定了技术方案的选择空间。以飞信 PC 客户端的三个版本为例：2004 年第一版只有一个 C++ 程序员，谈不上选型；2005 年第二版时间紧迫，选择了开发效率高的 C#；2008 年第三版人手充裕且无进度压力，又回到了 C++ 以追求性能和体验。同一个产品，在不同时间约束下做出了截然不同的技术选择。

**成本约束**：预算紧张时应优先考虑成熟的免费框架和工具，避免使用昂贵的商业软件或自己造轮子。

**风险约束**：新技术可能存在许可证风险、社区萎缩风险或学习曲线过陡的问题。在引入前必须做可行性分析，并准备好替代方案。

### 4. 技术选型的决策流程

要避免凭个人偏好做决策，应建立科学的流程：

**问题定义**：明确为什么需要选型？目标是提升开发效率？降低运行成本？还是解决性能瓶颈？只有目标明确，才有标准来评判方案。

**调研**：围绕目标，调研开源和商业方案。从是否满足目标、时间/成本/范围约束、可行性、风险、优缺点等维度分析。筛选后保留 2-3 个候选方案。

**验证**：用小型快速原型项目验证候选方案。例如飞信第二版选 C# 时，验证了一个关键问题——安装包体积。通过 Salamander 工具只打包必需的 dll，再用 7zip 压缩，成功将安装包控制在 10MB 以内，证明了方案可行。

**决策**：召集所有利益相关方，基于调研和验证结果做最终决策。如果纠结不决，负责人应当拍板——有时候迟迟不做选择比选错更糟糕。

### 5. 避开决策中的常见陷阱

**不要把观点当事实**：一个框架的粉丝只会描述它的优点，不会告诉你学习曲线有多陡峭。网上的技术分析文章可能是收了费的软文。在做决策前，必须亲自验证。

**不要先有结论再找证据**：如果心中已经偏好某个方案，后续的调研很容易变成只寻找有利证据的"确认偏误"。选型应当先收集事实，再得出结论。

---

## 第四讲：架构师思维——从码农到架构师的跃迁

### 1. 元帅的权杖

拿破仑的名言"每个法国士兵的背包里都装着一根元帅的权杖"。这并不是鼓励每个士兵都去当元帅，而是鼓励每个士兵都要具备大局观和战略思维——这样才能更好地理解和执行命令，提升整体战斗力。

对程序员来说同样如此：不一定要有架构师的头衔，但心中应当有架构师的思维。

### 2. 四种核心架构思维

**抽象思维**：从具体的业务需求中提取通用的模式和结构。就像用二元一次方程解鸡兔同笼问题一样，软件中也需要把具体的业务概念抽象成模型。例如极客时间的专栏文稿和视频课程，虽然表现形式不同，但都可以抽象为"课程"模型——包含标题、内容、作者、留言等通用属性。

**分治思维**：将复杂问题拆解为可独立解决的子问题。分层架构将 UI 和业务逻辑隔离；电商大促通过将流量分散到不同服务器集群来应对高并发。分治思维在编码层面也适用——把上千行的大函数拆成多个小函数，结构更清晰、更易维护。

**复用思维**：一段逻辑只编写一次。发现自己在复制粘贴代码时，就应当提取为公共组件或工具库。复用不仅提高开发效率，更重要的是确保修改的一致性——改一处就全局生效，而非到处找重复代码逐个修改。

**迭代思维**：好的架构不是一步到位的，而是先满足当前需求，再随着业务发展逐步演进。淘宝最初也只是一个普通的分层架构网站，随着用户量爆发式增长才逐步拆分为复杂的微服务体系。过度设计和设计不足同样危险——追求完美的一步到位会导致开发成本暴涨，而对需求变化的错误预测则会产生大量冗余代码。

### 3. 好的架构师的四个条件

一个好的架构师需要同时具备：架构师思维（抽象、分治、复用、迭代）、深入理解业务需求的能力、丰富的一线编码经验、以及良好的沟通能力。

特别值得警惕的是所谓的"PPT 架构师"——擅长在演示文稿中堆砌技术热词，但脱离一线开发，对业务和底层技术知之甚少。好的架构师一定是程序员出身，并且坚持参与编码和代码审查工作。因为不写代码就无法切身感受到设计缺陷带来的问题，也无法及时调整架构。

![架构师能力模型](../../assets/115f943a2e6377cc19197dabe75e6230.jpg)

### 4. 成为好架构师的路径

**先成为优秀的程序员**：通过大量编码实践培养架构思维。让自己的代码易读、易扩展、可复用。

**多模仿多学习**：找优秀的开源项目本地搭建，做中学。研读其架构设计思想，尝试进行二次开发。

**选对行业和平台**：架构师需要深入理解业务，而行业知识需要长时间积累。好的平台能提供大量实践机会——大厂才有机会实践高并发大数据的架构设计。

---

## 课后研讨任务

📋 **技术选型的现实博弈**

场景：你的团队要为一个重要的马拉松赛事开发抽签和检录系统，开发周期仅剩 2 个月。两位核心开发成员提议使用全新的 Go 语言加云原生微服务架构来开发，"性能更好，还能打造一个开源项目"。

**任务一**：作为项目技术负责人，请运用技术选型的三大约束原则和决策流程（问题定义 → 调研 → 验证 → 决策），分析该提议的合理性与风险，并提出你的决策建议。

**任务二**：赛事当天早上 7 点将有 10 万人瞬间扫码入场检录，请运用分治思维和冗余部署策略，设计一个能够应对该峰值的系统架构方案，并画出部署示意图。
