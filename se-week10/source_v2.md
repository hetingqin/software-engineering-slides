# 软件工程及体系结构 · 第 10 周

## 安全、发布与 DevOps：从代码到生产环境的最后一公里

> 电子信息工程专业硕士 | 3 学时
> 主讲人 | 何庭钦 | 271880026@qq.com

---

## 第一讲：软件安全——不是可选项，而是必选项

### 1. 安全事故的代价

在软件行业中，安全事故往往造成毁灭性的后果。CSDN 600 万用户密码明文泄露事件，暴露了最基本的安全错误——明文存储密码；国际信用评估巨头 Equifax 1.47 亿用户数据泄漏，直接导致 CEO 辞职、公司市值蒸发数十亿美元；更有甚者，一些创业公司因为严重的安全漏洞而直接倒闭。

这些事件反复证明：**安全问题可以直接导致一家企业的毁灭。** 安全不应当是"上线前补一补"的事后措施，而应当从系统设计阶段就开始考虑——这就是"安全设计（Secure by Design）"的理念。在软件的每一个阶段——需求分析、架构设计、编码实现、测试验证、部署上线——都需要同步考虑安全因素。

### 2. OWASP Top 10：每个开发者必须了解的安全威胁

OWASP（开放式 Web 应用程序安全项目）定期发布的 Top 10 安全威胁清单，是安全领域的基础知识：

1. **SQL 注入**：攻击者在输入框中构造恶意 SQL 语句，直接对数据库执行未授权操作。例如在登录表单的用户名输入 `' OR 1=1 --`，如果后端使用字符串拼接构造 SQL，则可以绕过身份验证。防御手段是使用参数化查询（Prepared Statement），永远不要用字符串拼接构造 SQL。

2. **XSS（跨站脚本攻击）**：在页面中注入恶意 JavaScript 代码。例如在评论框中输入 `<script>document.cookie</script>`，如果输出时未经转义，所有浏览该评论的用户的 Cookie 都会被窃取。防御手段是对所有用户输入在输出时进行 HTML 转义。

3. **CSRF（跨站请求伪造）**：利用用户已有的登录状态，在用户不知情的情况下伪造请求。例如攻击者在恶意网站嵌入一个指向银行转账接口的图片标签，当已登录银行的用户访问该恶意网站时，浏览器会自动携带 Cookie 发送转账请求。防御手段是使用 CSRF Token。

4. **身份验证缺陷**：弱密码策略（允许使用"123456"）、Session 管理不当（Session ID 不过期、不随机）、缺少多因素认证。

5. **敏感数据泄露**：密码以明文或弱哈希（如 MD5 不加盐）存储、HTTP 明文传输敏感信息。

6. **安全配置错误**：数据库使用默认密码、开放了不必要的管理端口、调试模式在生产环境未关闭。

7. **使用含有已知漏洞的组件**：不及时更新第三方依赖库。很多严重的安全事件（如 Log4Shell）都源于第三方库的已知漏洞未被及时修补。

8. **不安全的反序列化**：接受并反序列化不受信任的数据，可能导致远程代码执行。

9. **日志和监控不足**：无法及时发现和追溯攻击行为。攻击者可能已经潜伏在系统中数周甚至数月而不被发现。

10. **服务端请求伪造（SSRF）**：利用服务端发起对内网资源的未授权访问。

### 3. 安全防护的六道防线

软件安全不是单点防护，而是需要在多个层面同时展开：

- **密码安全**：使用 bcrypt 等自带盐值的哈希算法存储密码，禁止任何形式的明文存储或弱哈希（如 MD5）。
- **输入验证**：所有来自用户的输入都不可信——包括表单数据、URL 参数、HTTP Header、Cookie 等，必须在服务端进行严格校验和过滤。
- **传输加密**：全站启用 HTTPS，确保数据在传输过程中的机密性和完整性。
- **权限控制**：遵循最小权限原则。每个账户和服务只拥有完成其职责所必需的最低权限，绝不赋予多余权限。
- **依赖管理**：使用 Snyk、Dependabot 等工具定期扫描第三方依赖库的已知漏洞，及时升级修补。
- **安全审计**：定期进行代码安全审查和渗透测试，主动发现系统中的潜在漏洞，而非等待攻击者发现。

---

## 第二讲：版本发布——软件上线只是新的开始

### 1. 发布不是"扔上去就完了"

许多人将发布等同于"把代码放到服务器上"。然而，一次成功的发布需要完整的策略、规范的流程和可靠的回滚方案。发布是软件产品交付给用户的最后一步，也是风险最集中的一步——任何差错都可能直接影响业务收入和用户体验。

有人做过统计，大量的线上故障发生在发布后的一小时内。因此发布前后的监控尤为重要。

### 2. 语义化版本号（SemVer）

语义化版本号以 `MAJOR.MINOR.PATCH` 格式标识版本（如 `2.1.3`），每个部分的变化传达了明确的信息：

- **MAJOR**（主版本号）：包含不兼容的 API 变更。使用者升级时可能需要修改代码。例如从 1.x 升级到 2.0，意味着有破坏性变更。
- **MINOR**（次版本号）：新增了向下兼容的功能。使用者可以安全升级。例如从 2.0 升级到 2.1，只是新增了功能。
- **PATCH**（修订号）：修复了向下兼容的缺陷。应当尽快升级。例如从 2.1.2 升级到 2.1.3，只是修复了 Bug。

语义化版本号让依赖管理变得可预测：用户可以明确知道升级某个版本是否会破坏现有代码，工具也可以自动判断是否可以安全升级。

### 3. 发布策略的选择

不同规模和风险等级的系统，适用不同的发布策略：

| 策略 | 做法 | 风险 | 适用场景 |
|------|------|------|----------|
| **直接部署** | 用新版本直接替换旧版本 | 高，出问题需紧急回滚 | 小型内部系统 |
| **蓝绿部署** | 维护两套环境（蓝/绿），发布时将流量整体切换 | 低，秒级切换和回滚 | 对可用性要求高的关键系统 |
| **金丝雀发布** | 先给 1% 用户使用新版本，观察指标后逐步扩大 | 低，影响范围可控 | 大规模面向公众的系统 |
| **滚动更新** | 逐台替换服务器上的旧版本 | 中 | 容器化部署的微服务 |
| **A/B 测试** | 不同用户组使用不同版本，通过数据对比 | 低 | 产品功能实验 |

选择策略的原则是：系统越重要、用户量越大，越应该选择风险低、可控性强的策略。对于大型生产系统，金丝雀发布和蓝绿部署是最常用的做法。

### 4. 发布检查清单

每次发布前应逐项确认：所有自动化测试通过、代码审查完成且无遗留问题、数据库迁移脚本已准备并验证、回滚方案已制定并演练过、监控告警规则已配置、发布说明已撰写、相关团队已收到通知。

将这些检查项标准化为清单（Checklist），每次发布严格执行，可以有效避免因遗漏导致的线上事故。

---

## 第三讲：DevOps——打破开发与运维的壁垒

### 1. 什么是 DevOps？

DevOps 是 Development（开发）和 Operations（运维）的结合。它不是一个具体的岗位或工具，而是一种**文化和实践方法**。在传统的组织结构中，开发团队负责构建软件，运维团队负责部署和维护——两个团队之间存在一道"墙"：开发说"它在我的机器上能跑"，运维说"那你带着你的机器来生产环境吧"。

DevOps 的核心目标就是打破这道墙，通过自动化、协作和共同负责来加速软件交付的速度和可靠性。

![DevOps 生命周期](../../assets/2b3c01636b37728e5684d9bbc5e383e0.png)

### 2. DevOps 的五大核心原则

**自动化**：一切能自动化的环节都应当自动化——从代码编译、测试执行，到环境部署和监控告警。自动化消除了人为错误，提高了效率和一致性。手动操作执行一百次总会有几次出错，自动化脚本执行一万次也不会变。

**透明可度量**：所有关键指标都应当可视化。部署频率、变更失败率、从代码提交到上线的前置时间、故障恢复时间——这些指标需要被持续跟踪，用数据驱动决策和改进。

**协作**：开发、测试、运维团队紧密合作，共同为系统的交付和运行质量负责。不是"你负责写代码，我负责部署"，而是"我们一起负责把可靠的软件交付给用户"。

**快速反馈**：出现问题时团队能在第一时间获得通知并响应。反馈循环越短，问题的修复成本越低。在问题发生后一小时修复和一天后修复，代价可能相差十倍。

**持续改进**：定期回顾流程和工具，识别瓶颈和低效环节，不断优化。DevOps 不是"做一次就完事"的项目，而是一种持续进化的工作方式。

### 3. DevOps 工具链概览

DevOps 实践依托于一系列工具的协同工作，覆盖了软件交付的完整生命周期：

| 阶段 | 代表工具 |
|------|----------|
| 计划 | Jira、Trello、Linear |
| 编码 | Git、GitHub/GitLab |
| 构建 | Maven、Gradle、Webpack |
| 测试 | Jest、pytest、Selenium |
| 发布 | GitHub Actions、Jenkins、GitLab CI |
| 部署 | Docker、Kubernetes |
| 运维 | Ansible、Terraform |
| 监控 | Prometheus、Grafana、ELK Stack |

### 4. Infrastructure as Code（IaC）

基础设施即代码是 DevOps 的重要实践之一：用代码（而非手动操作）来定义和管理服务器、网络、存储等基础设施。

使用 Terraform、Ansible、Pulumi 等工具，可以将基础设施配置纳入版本管理——提交、审查、回滚，和管理应用代码完全相同。这从根本上解决了"环境漂移"问题（开发环境和生产环境不一致），同时实现了基础设施的可重复创建、可版本化管理和可审计追溯。

### 5. 容器化与编排

**Docker** 将应用程序及其所有依赖打包成一个独立的容器。容器内包含运行应用所需的一切：代码、运行时环境、系统库和配置文件。这彻底解决了"在我的机器上能运行"的问题——容器在任何环境中都以完全相同的方式运行，从开发者的笔记本到生产服务器。

**Kubernetes（K8s）** 是容器编排平台，负责管理大规模容器集群。它提供了自动化部署（一条命令更新所有容器）、自动伸缩（流量增加时自动增加容器实例）和自愈（容器崩溃后自动重启或替换）等关键能力。

---

## 本周核心公式

> **DevOps = 文化（协作）+ 自动化（CI/CD/IaC）+ 度量（监控/反馈）+ 共享（打破壁垒）**

---

## 课后研讨任务

📋 **安全与发布策略设计**

**任务一**：审视你正在参与的课程项目，参考 OWASP Top 10，列出至少 3 个可能存在的安全风险，并为每个风险提出具体的防护措施和验证方法。

**任务二**：假设你的项目需要在下周部署到学校服务器上供全班同学使用。选择一种合适的发布策略（从五种策略中选择），说明选择理由。制定一份包含至少 7 个检查项的发布检查清单，并说明如果上线后出现问题，你的回滚方案是什么。
