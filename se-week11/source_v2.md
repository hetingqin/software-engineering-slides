# 软件工程及体系结构 · 第 11 次

## 软件工程及体系结构

### **高级进阶与最佳实践：故障处理、复盘与团队应用**

> 电子信息工程专业硕士 | 3 学时
> 主讲人 | 何庭钦 | 271880026@qq.com

---

## 第一讲：遇到线上故障，你和高手的差距在哪里？

### 1. 新手与高手应对故障的差距

无论是大公司还是小团队，线上故障都在所难免。应对故障的方式直接反映出程序员的水平阶段。

**差距一：面对复杂故障无从下手 vs 有条不紊**
*   **新手**：内存飙升、CPU 居高不下时立刻懵掉。
*   **高手**：按照固定步骤分析（① 评估影响范围 → ② 试图重现问题 → ③ 临时与终极方案 → ④ 风险评估与持续优化）。本质上是系统化解决问题的能力。

**差距二：急于写代码打补丁 vs 优先恢复生产**
*   **新手**：发现 Bug 就迫不及待改代码，容易引入更严重的 Bug。
*   **高手**：首先**评估故障评级（如 P0、P5）**。如果是核心业务大面积故障，首要任务是**恢复生产**（如回滚版本、重启服务、服务降级），修复 Bug 是其次。同时保留现场（日志、Dump 文件）。

**差距三：大海捞针 vs 逐步缩小范围**
*   **新手**：看日志看代码找不到头绪。
*   **高手**：通过有效的手段**逐步缩小问题范围**。例如：
    *   重现 Bug：将问题锁定在几步操作代码中
    *   分析变更代码：如果是最近部署后出现的
    *   分析 Dump 文件：定位消耗资源过高的线程和变量
    *   排除法：对微服务请求逐一排查正常环节

**差距四：修完就忘 vs 刨根问底**
*   **新手**：重启恢复了就抛之脑后，下次还会犯。
*   **高手**：仔细分析深层次原因，进行流程验证与改进（如增加测试时间，改善部署流程），避免同类故障再次发生。

### 2. 大厂如何处理线上故障？

大厂的核心做法是：**将高手解决问题的方式，变成标准流程和操作手册（SOP），并通过反复演习强化。**

**一般标准流程：**
1.  **故障评级**：根据影响范围评级（P0大面积瘫痪，紧急；P5体验问题，延后）。
2.  **恢复生产**：部署回滚、服务降级等手段止损。
3.  **分析与修复**：定位 Bug 并修复。
4.  **复盘记录**：记录全过程，提出后续改进方案。

### 3. 大厂值得借鉴的故障处理机制

*   **报警与轮值机制（On-Call）**：
    *   目标：让**最熟悉代码的开发人员**第一时间响应。
    *   做法：主备排班，24 小时开机。15 分钟无响应则逐级上报（经理→总监→VP→CEO）。
*   **实战演习（混沌工程 Chaos Engineering）**：
    *   不要等出问题才发现备份不可用。
    *   **Netflix 的混乱猴子（Chaos Monkey）**：随机在生产环境关闭服务，测试系统稳定性。像打疫苗一样建立免疫力。
*   **全链路日志记录与分析**：
    *   给每一个请求分配唯一标识（`requestId`）。
    *   请求经过的所有服务都带上这个标识，记录输入、输出和耗时，出问题时一搜就能串起整个调用链路。

---

## 第二讲：日志管理——排查问题的"千里眼"

### 1. 为什么需要统一的日志管理？

原始查看方式（肉眼找文本、grep 命令）在微服务、容器化时代彻底失效：几十个服务、成百上千个容器，难以逐一登录排查。

**日志管理（Log Management）**：指对系统产生的数据进行统一收集、筛选解析、统一存储，并提供便捷的检索和监控。

### 2. 日志管理的三大价值

*   **集中检索快速定位**：支持类似 SQL 的查询，跨微服务、分布式节点秒级定位。
*   **结果可视化监控**：实时将零散的日志（如 API 耗时、响应状态码）聚合成统计图表，直观呈现系统性能的升降。
*   **自动化阈值报警**：例如"错误率超过 10%"或"90% 请求延迟超 1 秒"时自动通知开发人员。

### 3. ELK：日志管理的黄金架构

业界标配的日志解决方案——**ELK (Elasticsearch + Logstash + Kibana)**。

*   **Logstash（采集与解析）**：
    *   从各个服务器和容器收集原始日志（文本/日志流）。
    *   过滤并**结构化解析**（提取时间、IP、应用名、状态码），以便后续索引。
*   **Elasticsearch（存储与搜索）**：
    *   强大的分布式搜索引擎，支持全文检索。负责海量日志的高效存储和极速查询。
*   **Kibana（可视化）**：
    *   针对 ES 的图形化交互界面。用于查询数据并生成美观的监控仪表盘（Dashboard）。

*进阶扩展*：可以搭配 `ElastAlert`、`Watcher` 或 `Grafana` 实现更复杂的自动监控报警；也可以结合 `PagerDuty` 实现智能的排班轮值自动呼叫。

---

## 第三讲：项目复盘——把经验转化为能力

### 1. 什么是真正的项目复盘？

复盘源自围棋，指对弈后重演下棋过程，寻找更好走法。在软件工程中，复盘是**分析讨论开发中的问题，总结成功经验与失败教训，将经验转化为团队能力**的过程。

**常见无效复盘：**
*   流水账回顾（说不清哪里没做好）
*   甩锅给客观原因（"客户太坑"，没有总结改进方案）
*   知道原因但不知应对（找不出落地措施）

### 2. 科学复盘的四步法（参考联想复盘法）

**第一步：回顾项目目标**
*   写出当初的量化目标和里程碑。
*   ❌ "目标是做一款伟大的产品"（主观无法衡量）
*   ✅ "3个月上线学习产品核心功能，上线 Bug 率低于上个版本，2个月内测，3个月全量发布"

**第二步：评估项目结果**
*   将实际结果与目标对比，客观列出**好的差异**和**坏的差异**。
*   *好*：线上稳定严重 Bug 少。
*   *坏*：中间需求变更频繁，最终项目延期了 1 个月。
*   （此阶段只罗列现象，不急于分析原因展开争吵）

**第三步：分析原因**
*   分析好/坏差异背后的深层原因（营造不甩锅的氛围，对事不对人）。
*   *好的原因*：启用了自动化测试和持续集成工具。
*   *坏的原因*：项目周期设置过长，无法响应客户想法的变化。

**第四步：总结规律，落实行动**
*   运用软件工程知识总结为规律，并转化为具体的**Action Item（待办事项）**：
    *   继续保持自动化测试；
    *   尝试将长周期改为 2-4 周的短周期敏捷迭代来吸收需求变更；
    *   规范工单系统跟进需求。

*提示：不要只在项目结束时复盘。线上特大故障后、每个敏捷 Sprint 结束后都可以组织阶段性复盘。*

---

## 第四讲：最佳实践——小团队如何应用软件工程？

### 1. 小团队开发的"三座大山"

很多初创公司或小型开发团队（3-5人），痛点极其明显：
*   **成本敏感**：薪资无竞争力难招大牛；不愿买商业工具；排期紧逼。
*   **人少活多**：全栈开发是常态；缺乏产品/测试梯队配置；严重依赖极少数大牛。
*   **流程缺失**：无需求分析直接写代码；老板直接口头插需求；无自动化测试上线修补丁。

### 2. 第一维度：团队建设（人的基础）

软件工程再好，也得靠人去执行。
*   **招人与培养**：招不到技术大牛，就招**有学习和解决问题潜力的**年轻程序员（实习生）。通过**师徒制（Mentor）**快速帮带。
*   **高效反馈机制**：小团队更需要用强制的代码审查（Code Review）和自动化测试来建立技术底线与快速反馈，在 Review 中互相学习提升。
*   **技术分享与大牛角色边界**：定期进行内部技术分享；技术大牛不要闷头包揽所有代码，必须分出一半精力做架构设计和带新人，使团队持续健康发展。
*   **扁平化管理**：用"自驱动"替代"发号施令"（引入敏捷的认领任务看板），故障不仅不甩锅还要共同复盘。遇到长期阻碍团队规范的刺头，必须果断汰换。

### 3. 第二维度：流程建设（从小而美开始）

*   **选择合适的开发模型**：
    *   小团队需求变化极快，最适合**敏捷开发（快速迭代）**。
    *   固定 2-4 周的短周期；迭代内**拒绝插队打断**；每个迭代必有验收与内部回顾会议。
*   **源码为主线的工具链**：
    *   坚决摒弃 QQ 传代码。使用云端托管平台（GitHub/GitLab/Gitee），依托云自带的持续集成（CI）节约运维成本。实行 GitHub Flow。
*   **建立防火墙：外部需求对接流程**：
    *   建立统一的任务池（Backlog），不要让老板/业务人员越过系统直接对程序员下命令。
    *   想插图？进入排队池，优先级在迭代计划会上公开PK决定。像火车站排队机制一样治理混乱。

---

## 第五讲：为什么程序员的业余项目大多都死了？

### 1. Side Project 死亡的三大病因

程序员做业余项目有天然的代码优势，但极少存活：

1.  **想法大，时间少**：想做个在线 Excel 对标微软，但每天下班只有 1 小时，长时间无进展导致激情耗尽放弃。
2.  **迷失于技术堆砌，缺乏约束**：过度追求引入时髦或不熟悉的新技术栈（"我要用 GraphQL+WebSockets!"），变成技术试验田，没有时间节点约束，导致永未交付。
3.  **缺乏产品与运营思维**：闭门造车，做的东西对别人没价值；做出来后不懂得怎么让用户知道，没用户使用最终关停。

### 2. 软件工程视角的破局之道

*   **应用"金三角理论"（MVP）破除想法大**：
    *   业余项目**时间**已被限死（极少），**成本**被限死（没钱）。想成功必须大幅缩小**范围（功能）**。
    *   采用 **MVP（最小可行性产品）**，砍掉边缘功能，只发布最核心体验，抛给市场验证再迭代。
*   **引入项目约束与 Dead Line 破除技术沉迷**：
    *   把业余工作当成**正规项目**来管，写项目计划和里程碑。
    *   **公开承诺法**：在朋友圈/论坛公布"下个月某天发新版"，借助外部监督强加 Dead Line（第一生产力）。
*   **锻炼产品感与联合运营**：
    *   通过解决自己或亲友的实际痛点出发挖掘需求，善用成熟 UI 模板。
    *   想清"产品给用户的价值""商业模式（赚钱逻辑）""曝光渠道"。
    *   寻找互补的合伙人构成**微型团队**（写代码+产品设计+推广运营）。

### 3. 去做吧，哪怕失败！

即使业余项目大概率失败，依然强烈建议每个程序员去做：
*   它是低成本体验新技术的最佳试验场；
*   在这里你是 Owner，能自由实践你的架构理念；
*   强制性地帮你建立起**产品、测试、运营和工程结合的大局观**；
*   失败的项目本身就是你履历中极佳的"架构与复盘"谈资。

---

## 课后研讨任务

📋 **综合演练：线上故障与团队诊疗室**

**场景一（线上救火）：**
你公司的核心售卖系统在周五晚上 8 点突然出现部分用户下单失败的问题报错 `TimeoutError`。
1. 请用"新手"和"高手"两种视角，分别描述可能发生的操作剧情。
2. 如果你是此时的架构师，写出你解决此事故的 4 个规范步骤，以及事后如何用混沌工程预防。

**场景二（拯救濒危小团队）：**
你刚空降到一个只有 4 名开发人员的创业公司做 CTO。现状是：所有代码在一个 SVN 分支里混杂，没有测试人员，老板每天随时把想法塞给程序员做，团队每天加班到半夜但业务进展极度缓慢。
*   为了在第一个月稳住阵脚并提升效率，你准备颁布哪 **3 条最核心的不可侵犯的流程铁律**？（说明设立该铁律的理论支撑与想要解决的具体痛点） 
