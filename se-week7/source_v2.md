# 软件工程及体系结构 · 第 7 周

## 核心开发技能与持续交付：消除低效，打造自动化流水线

> 电子信息工程专业硕士 | 3 学时
> 主讲人 | 何庭钦 | 271880026@qq.com

---

## 第一讲：技术债务——代码中的隐形负债

### 1. 什么是技术债务？

每个开发者都遇到过这样的场景：为了赶进度，单元测试"以后再补"；需求变了但不想改架构，绕了一大圈在旧代码上加了一堆补丁；接手的旧系统没有文档没有注释，谁也不敢动。这些由于走捷径而积累的架构质量和代码质量问题，就叫做**技术债务**。

在项目管理金三角中，质量处于时间、成本和范围三者的中心。范围不缩减、成本不增加、还想压缩时间——被牺牲的就是质量。而技术债务正是这种质量透支的直接体现。

### 2. 技术债务的利息与良性负债

技术债务与金融债务有着相似的特性：

**利息**：随着技术债务的积累，后续开发的成本会持续增加。原本 4 天能完成的功能，因为代码臃肿、结构混乱，现在需要 5 天——多出的 1 天就是利息。你需要花时间梳理混乱的代码找到合适的修改位置，修改后还可能引入新的 Bug，需要更多时间修复。

**不全是坏事**：在特定场景下，有计划地欠下技术债务是合理的策略。为了抢占市场先机而"战略性欠债"，先用"快猛糙"的方式推出产品，事后再安排重构——这是一种良性负债。快速原型模型本身就是一种"故意欠债快速验证"的做法，如果验证失败，这笔债务甚至不需要偿还。关键在于：你是否清楚自己欠了多少债，以及是否有明确的偿还计划。

### 3. 技术债务的四象限分类

Martin Fowler 将技术债务按"轻率/谨慎"和"有意/无意"两个维度分为四个象限：

- **轻率且有意**：明知道不做设计就开干会有后果，但就是不管——"我们没时间做设计"。短期可能节省时间，但利息持续累积，最终可能失控。
- **谨慎且有意（良性负债）**：清楚知道债务的代价和收益，为了赶工有意为之，并已制定重构计划——"先发布，后续安排两个 Sprint 专门还债"。这是最可控的技术债务。
- **轻率且无意（最危险）**：团队对什么是好的架构和编码习惯一无所知，写出的代码根本不知道自己在欠债——"什么是分层架构？"既没得到债务收益，还要被利息无声地拖垮。
- **谨慎且无意**：团队重视质量，但业务变化超出了原有设计的预期范围，导致架构无法适应新需求——"当时确实无法预见业务会这样发展"。这类债务难以避免，关键是能否及时识别并进行架构升级。

![技术债务四象限](../../assets/9ee240f45ed039399819232419bb3088.png)

### 4. 识别技术债务的信号

与银行账户不同，技术债务不会主动告诉你余额。但以下信号通常意味着技术债务已经累积到需要干预的程度：

- **开发速度明显下降**：同样复杂度的功能，之前一周做完，现在需要两周。在敏捷开发中表现为每个 Sprint 完成的故事点数持续下滑。
- **单元测试覆盖率低**：使用覆盖率检测工具发现覆盖率很低或持续下降。
- **代码规范检查（Lint）错误率高**：eslint、pylint 等工具报出大量警告和错误。
- **Bug 数量不降反升**：即使没有新功能开发，Bug 数量也居高不下或呈上升趋势。
- **使用的技术栈过于陈旧**：所用的框架或语言版本已不再维护更新。

### 5. 三种还债策略

Martin Fowler 有一张图描述了设计质量与开发速度的关系：在项目初期，不做设计直接编码确实更快，但跨过一个临界点后，代码质量问题带来的阻力急剧增大，开发速度反而急剧下降。

![设计与速度的交叉点](../../assets/7951ea8fb6d669260055ab07c624fb16.png)

**重写（一次还清）**：将旧系统推翻重来。优点是可以基于当前需求重新进行良好的设计，精简不需要的功能。缺点是工作量大，新旧系统并行维护压力很大，新系统稳定也需要时间。如果有成熟的开源方案可以替代（例如用 WordPress 替换自研 CMS），重写成本可以很低。

**维持（只还利息）**：对严重问题进行修修补补，维持基本运转。成本最低，适用于不再新增功能或生命周期即将结束的系统。但如果系统还在持续发展，维护成本只会越来越高。

**重构（分期付款）**：在不改变系统外部行为的前提下，逐步改善内部结构。每次只改一部分模块，风险可控，对业务影响最小。这是最折中也最常推荐的策略。

选择哪种策略的关键标准是**投入产出比**——收益是否高于投入。如果纠结不决，选择重构通常是最稳妥的。

### 6. 预防优于治疗

预防技术债务的三个有效措施：**预先投资**（好的架构设计和高质量代码像一种技术投资）、**不走捷径**（坚持代码审查、保障测试覆盖率）、**及时还债**（将欠下的债务记录到任务跟踪系统中，安排在后续迭代中偿还）。

---

## 第二讲：高效开发的三大原则

### 1. 积极主动——扩大你的影响圈

面对项目中的问题，最常见的反应是归咎于外因："进度太紧"、"产品经理不靠谱"、"996 是福报"。但无论责任在谁，抱怨对改善现状没有任何帮助。

《高效能人士的七个习惯》提出两个核心概念：**关注圈**（你关注的所有事）和 **影响圈**（你能改变的事）。高效的做法是减少在不可控事物上的精力消耗，把时间集中在自己能影响的事情上。

具体做法：当对新技术、新方法的第一反应是"不可能""没用"时，给自己几秒钟暂停——把"不可能"改为"我试试""我再想想"。反复这样提醒自己，消极的本能反应就会逐渐变成积极的思考习惯。

扩大影响圈意味着主动走出自己的职责边界。例如产品经理给的需求不完善，与其等做完后抱怨，不如在接到需求的第一时间就用极端场景和边界条件来验证——"文字超长时布局怎么办？""网络断开时显示什么？""数据为空时列表怎么呈现？"

### 2. 以终为始——先想清楚目标再动手

新手拿到需求就写代码，写到一半发现方向错了反复返工。老手会先分析需求、确认细节、画简单设计图、想清楚模块关系，然后才编码——一气呵成，既快又好。

一个反面案例：刚毕业的工程师被分配开发一个内容管理系统，过程中觉得手写数据表映射代码太枯燥，开始编写代码生成工具——而为了写代码生成工具，又开始学习 Winform……几个月过去了，内容管理系统还停留在最初的几行代码。经常停下来问自己：**我的原始目标是什么？我正在做的事是我的目标吗？**

三个关键要素：**目标**（定期审视是否偏离）、**原则**（为自己设定可执行的编码原则，如"先跑通再优化"、"DRY"、"PR 尽量小"）、**计划**（细化任务、给出时间点，用进度压力倒逼自己专注目标）。

### 3. 要事第一——时间四象限法

程序员的日常可能被大量杂事打断：临时会议、聊天消息、同事请教、系统升级提示……使用时间四象限法管理优先级：

- **重要紧急**：立即处理（生产环境故障、关键 Bug）。
- **重要不紧急**：分配最多时间（代码重构、自动化测试、需求评审）。如果长期忽视，这些事会逐渐演变为重要紧急事项。
- **紧急不重要**：集中批量处理（聊天消息、非关键会议）。在专注工作时全屏、关闭所有通知，完成一个阶段后再统一回复。
- **不重要不紧急**：能不做就不做（非必要的系统更新、无关紧要的技术讨论）。

---

## 第三讲：持续集成与持续交付

### 1. 集成的演进史

在瀑布模型时代，集成发生在开发阶段接近尾声时。各开发者长期在各自分支上独立工作，最后同时合并——编译失败、接口不一致、配置冲突接踵而来，可能持续数天甚至数周才能产出一个勉强可用的版本。

Martin Fowler 说："如果一件事很痛苦，那就更频繁地做。"**持续集成（CI）** 的核心思想就是把这个痛苦的过程变成每天多次的日常操作：每次有代码提交到主干之前，自动触发编译和全量测试，只要有一个测试用例失败，就不允许合并。

![持续集成流水线](../../assets/8de10a3d3b2e46e2f8b945bdf4d37fbf.png)

核心价值：通过自动化测试保证主干代码始终可用；频繁集成让团队成员及时获取最新代码，避免问题在后期才暴露（如类库版本不一致、API 格式不匹配）。

### 2. 部署与交付的演进

部署从手动操作逐步走向自动化：

**手动部署时代**：开发人员熬通宵手动修改配置文件、编译打包、部署到服务器。改错一个符号可能导致早上全国用户打不开网站。后来分工细化，出现了专门的运维岗位，按照部署文档逐步操作——但依然繁琐、易出错、耗时长。

**每日构建（Daily Build）**：下班后自动从源码管理器获取最新代码、编译、部署到测试环境。初步实现了自动化，但无法保证代码质量。

**持续交付（CD）**：在持续集成的基础上更进一步。自动化测试通过后，系统自动完成打包和部署到测试环境。生产环境的部署只需一次人工确认——点击一个按钮或执行一条命令即可完成。所有环境配置和部署步骤都已自动化，因人为操作失误导致的部署失败几乎被完全消除。

![持续部署流水线](../../assets/a2e354c88a3bf0df871174980ef3a900.png)

### 3. 持续部署：全自动化的终极形态

持续部署取消了人工确认环节，代码通过所有自动化测试后直接发布到生产环境。这对测试覆盖率和稳定性提出了极高要求（通常需要 90% 以上的覆盖率）。

为降低风险，持续部署通常结合**功能开关（Feature Flag）**使用：新功能上线时默认关闭，通过配置逐步对部分用户开放。如果发现问题，关闭开关即可，无需回滚代码。

### 4. 你应该尽早应用持续交付

持续交付与开发模型无关——瀑布模型也可以受益。它的价值在于：尽早暴露问题、极大提升效率、提升代码质量、降低项目长期成本。搭建持续交付环境的准备工作包括：使用源代码管理工具（Git 是标配）、编写自动化测试代码（覆盖率可以逐步提升）、实现自动化打包和部署脚本。

主流的持续集成工具包括 Jenkins（开源，功能强大）、GitHub Actions（与 GitHub 无缝集成）、GitLab CI（性价比高）、Azure Pipelines（与微软技术栈集成良好）等。

---

## 课后研讨任务

📋 **技术债务与自动化的抉择**

场景：你的团队正在接管一个遗留项目，代码中没有任何自动化测试。距离新版本上线还有 1 周，老板要求必须在旧系统上新增一个大型促销功能。

**任务一**：在旧代码上硬加功能只需 3 天但会引入严重耦合；顺便重构核心模块需要 6 天。请分析你应该选择哪种策略——"谨慎/有意欠债"还是"分期重构"？用技术债务四象限模型说明你的决策逻辑。

**任务二**：假设成功上线后获得了 2 个月缓冲期，请设计一份持续集成推行方案：选择什么工具、制定什么团队规范、第一周先做什么、第一个月达到什么效果？
